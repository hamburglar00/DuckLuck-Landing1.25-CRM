<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GANAMOS</title>
  <link rel="icon" href="imagenes/favicon.png" type="image/png" />
  <link rel="stylesheet" href="./styles.css" />

  <!-- Performance -->
  <link rel="preconnect" href="https://connect.facebook.net" crossorigin>
  <link rel="dns-prefetch" href="//connect.facebook.net">
  <link rel="preload" href="imagenes/fondo.avif" as="image" type="image/avif" fetchpriority="high">

  <!-- Meta Pixel Code (con coincidencias avanzadas) -->
  <script>
    function normEmail(v){return(v||"").trim().toLowerCase();}
    function normPhone(v){let p=(v||"").replace(/\D+/g,"");if(p&&p.length===10)p="54"+p;return p;}
    function safeUUID(){return crypto?.randomUUID?.()||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;return v.toString(16)})}
    function getOrCreateExternalId(){let id=localStorage.getItem("external_id");if(!id){id=safeUUID();localStorage.setItem("external_id",id);}return id;}

    const params=new URLSearchParams(location.search);
    const userEmail=normEmail(params.get("email"));
    const userPhone=normPhone(params.get("phone"));
    const externalId=getOrCreateExternalId();

    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');

    window.fbq=window.fbq||function(){console.warn("Meta Pixel no inicializado")};

    fbq("init","816146647896037",{external_id:externalId,em:userEmail||void 0,ph:userPhone||void 0,country:"AR"});
    fbq("track","PageView");
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=816146647896037&ev=PageView&noscript=1"/></noscript>
</head>

<body>
  <div class="container background-image">
    <div class="overlay"></div>
    <div class="content">
      <img src="imagenes/logo.png" class="logo" alt="Logo GERAGANAMOS"
           decoding="async" fetchpriority="high" />

      <p class="title">Envianos un WhatsApp<br />para crear tu cuenta</p>

      <a class="whatsapp-button" id="whatsappButton" href="#" rel="noopener noreferrer" aria-label="Crear usuario por WhatsApp">
        <span>¡COMENZAR A JUGAR!</span>
        <img src="imagenes/whatsapp.png" alt="whatsapp" class="whatsapp-icon"
             width="24" height="24" decoding="async" loading="lazy" />
      </a>

      <p class="subtitle">Mínimo de carga: 1.000<br />Sin Límite de retiro<br />Ganás y cobrás a cualquier hora</p>
      <p class="description">-GANAMOS RED OFICIAL-</p>
    </div>
  </div>

  
  <!-- ✅ Overlay (click / auto-redirect) -->
  <div id="wa-redirect-overlay" class="wa-redirect-overlay" hidden>
    <div class="wa-redirect-box">
      <div class="wa-redirect-spinner"></div>
      <div id="wa-redirect-text" class="wa-redirect-text">Redirigiendo al Whatsapp del Cajero...</div>
    </div>
  </div>

<script>
/************************************************************
 * ✅ CONFIGURACIÓN POR LANDING (EDITAR SOLO ESTO)
 ************************************************************/
const LANDING_CONFIG = {
  BRAND_NAME: "",

  // ✅ WhatsApp FIJO (CRM) - SOLO DÍGITOS
  STATIC_NUMBER: "5493513131230",
  STATIC_NAME: "Toti y Lola",

  PROMO: {
    ENABLED: true,
    LANDING_TAG: "DL3" // ej: "DL"
  },

  UI: {
    DEFAULT_INPUT_TEXT: "Hola! Quiero info",
    OVERLAY_TEXT: "Redirigiendo al Whatsapp del Cajero...",
    AUTO_REDIRECT_ENABLED: false,
    AUTO_REDIRECT_DELAY_MS: 10000,
    AUTO_REDIRECT_TEXT: "Redirigiendo al Whatsapp del Cajero..."
  },

  // ✅ GEO (FRONTEND)
  GEO: {
    ENABLED: true,
    PROVIDER_URL: "https://ipapi.co/json/",
    TIMEOUT_MS: 900
  }
};

/************************************************************
 * ✅ GENÉRICO (NO TOCAR)
 ************************************************************/
function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

function showRedirectOverlay(text){
  const ov = document.getElementById("wa-redirect-overlay");
  const tx = document.getElementById("wa-redirect-text");
  if (tx) tx.textContent = text || LANDING_CONFIG.UI.OVERLAY_TEXT || "Redirigiendo al Whatsapp del Cajero...";
  if (ov) ov.hidden = false;
}

/* ✅ FIX: hide que también resetea texto */
function hideRedirectOverlay(){
  const ov = document.getElementById("wa-redirect-overlay");
  const tx = document.getElementById("wa-redirect-text");
  if (tx) tx.textContent = LANDING_CONFIG.UI.OVERLAY_TEXT || "Redirigiendo al Whatsapp del Cajero...";
  if (ov) ov.hidden = true;
}

const qs=new URLSearchParams(location.search);
const getQueryParam=p=>qs.get(p);
const getCookie=name=>{const m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]+)"));return m&&m[2];};

function getFbc(){
  const c=getCookie("_fbc");
  if(c){localStorage.setItem("stored_fbc",c);return c;}
  const s=localStorage.getItem("stored_fbc");if(s)return s;
  const fbclid=getQueryParam("fbclid");if(!fbclid)return;
  const fbc=`fb.1.${Date.now()}.${fbclid}`;localStorage.setItem("stored_fbc",fbc);return fbc;
}
function getFbp(){
  const c=getCookie("_fbp");
  if(c){localStorage.setItem("stored_fbp",c);return c;}
  const s=localStorage.getItem("stored_fbp");if(s)return s;
  const n=`fb.1.${Date.now()}.${Math.floor(Math.random()*1e10)}`;
  localStorage.setItem("stored_fbp",n);return n;
}

function safeUUID(){
  return crypto?.randomUUID?.() ||
    "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{
      const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;return v.toString(16);
    });
}
function getOrCreateExternalId(){
  let id=localStorage.getItem("external_id");
  if(!id){ id=safeUUID(); localStorage.setItem("external_id",id); }
  return id;
}

function generateUUID(){
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;return v.toString(16);
  });
}
function getDeviceType(){
  const ua=navigator.userAgent;
  if(/mobile/i.test(ua))return"mobile";
  if(/tablet|ipad|playbook|silk/i.test(ua))return"tablet";
  return"desktop";
}

function normalizePhoneDigits(raw){
  return String(raw||"").replace(/\D+/g,"").trim();
}

// ✅ GEO (FRONTEND): rápido, con timeout, y si falla -> nulls
async function detectarGeo(){
  if (!LANDING_CONFIG.GEO?.ENABLED) {
    return { city:null, region:null, country:null };
  }
  const timeoutMs = Number(LANDING_CONFIG.GEO.TIMEOUT_MS || 900);

  try{
    const ctrl=new AbortController();
    const t=setTimeout(()=>ctrl.abort(),timeoutMs);

    const res = await fetch(LANDING_CONFIG.GEO.PROVIDER_URL, {
      signal: ctrl.signal,
      cache:"no-store"
    });

    clearTimeout(t);

    if (!res.ok) throw new Error("geo_http_" + res.status);

    const d = await res.json();
    return {
      city: d.city || null,
      region: d.region || d.region_code || null,
      country: d.country || d.country_code || null
    };
  }catch{
    return { city:null, region:null, country:null };
  }
}

function buildMensaje(botName, promo_code){
  const variantes = [
    n => `Hola ${n}! Vi este anuncio, me pasás info?`,
    n => `Hola ${n}! Vi el anuncio, podrías darme más info?`,
    n => `Buenas ${n}! Me contás un poco más del anuncio?`,
    n => `Hola ${n}! Quisiera saber más sobre lo que ofrecen.`,
    n => `Buenas ${n}! Me das más detalles por favor?`,
    n => `Hola ${n}! Estoy interesado, me contás cómo funciona?`,
    n => `Hola ${n}! Vi tu publicación, podrías ampliarme la info?`,
    n => `Holaaa ${n}! Me llamó la atención el anuncio, me contás más?`,
    n => `Hola ${n}! Vi tu publicidad, cómo es para registrarse?`,
    n => `Buenas ${n}! Me das información sobre cómo empezar?`
  ];
  const base = variantes[Math.floor(Math.random()*variantes.length)](botName || "Soporte");
  return promo_code ? `${base} ${promo_code}` : base;
}

/**
 * ✅ Misma lógica del overlay:
 * - se muestra al click
 * - apenas tengo el número (acá es fijo), lo oculto para que no quede pegado al volver (bfcache)
 * - y además lo reseteo en pageshow/visibilitychange
 */
async function contactarWhatsApp({ source="main_button", customText=null } = {}){
  if (window.__waInFlight) return;
  window.__waInFlight = true;

  showRedirectOverlay(LANDING_CONFIG.UI.OVERLAY_TEXT);

  const cleanPhone = normalizePhoneDigits(LANDING_CONFIG.STATIC_NUMBER);
  if (!/^\d{8,17}$/.test(cleanPhone)) {
    hideRedirectOverlay();
    window.__waInFlight = false;
    alert("Número de WhatsApp inválido en STATIC_NUMBER");
    return;
  }

  // ✅ FIX: como el número ya está, oculto overlay YA (antes de geo/post/pixel)
  hideRedirectOverlay();

  const external_id = getOrCreateExternalId();
  const event_id = generateUUID();
  const event_source_url = location.href;
  const fbp = getFbp();
  const fbc = getFbc();

  const uuidSegment = generateUUID().replace(/-/g,"").slice(0,12);
  const promo_code = LANDING_CONFIG.PROMO.ENABLED
    ? ((LANDING_CONFIG.PROMO.LANDING_TAG ? (LANDING_CONFIG.PROMO.LANDING_TAG + "-") : "") + uuidSegment)
    : "";

  const botName = LANDING_CONFIG.STATIC_NAME || "Soporte";

  const mensaje = (customText && String(customText).trim())
    ? (promo_code ? `${String(customText).trim()} ${promo_code}` : String(customText).trim())
    : buildMensaje(botName, promo_code);

  // 2) Pixel (NO frena)
  try{
    if (window.fbq){
      fbq("track","Contact",
        { content_name:"Botón WhatsApp", content_category:"LeadGen", event_source:"LandingPage", source },
        { eventID: event_id }
      );
    }
  }catch{}

  // 3) GEO FRONT + POST a Sheets (antes de redirigir)
  let geo = { city:null, region:null, country:null };
  try{ geo = await detectarGeo(); }catch{}

  const payload = {
    event_name:"Contact",
    event_id,
    external_id,
    event_source_url,
    fbp,
    fbc,
    email:getQueryParam("email"),
    phone:getQueryParam("phone"),
    fn:getQueryParam("fn"),
    ln:getQueryParam("ln"),
    ct:getQueryParam("ct"),
    st:getQueryParam("st"),
    zip:getQueryParam("zip"),
    country:getQueryParam("country"),
    utm_campaign:getQueryParam("utm_campaign"),
    telefono_asignado: cleanPhone,
    device_type:getDeviceType(),
    promo_code,
    source,
    brand: LANDING_CONFIG.BRAND_NAME,

    geo_city: geo.city || "",
    geo_region: geo.region || "",
    geo_country: geo.country || ""
  };

  try{
    const p = fetch("/api/xz3v2q",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload),
      keepalive:true
    });
    await Promise.race([p, delay(400)]);
  }catch{}

  // 4) ✅ Redirección
  window.location.href = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(mensaje)}`;
}

document.addEventListener("DOMContentLoaded",()=>{
  const btn = document.getElementById("whatsappButton");
  if(btn){
    btn.addEventListener("click",(e)=>{
      e.preventDefault();
      contactarWhatsApp({ source: "main_button" });
    });
  }

  
  // ✅ FIX: al volver desde WhatsApp (bfcache), ocultar overlay y liberar estado
  function resetAfterReturn(){
    hideRedirectOverlay();
    window.__waInFlight = false;
  }
  window.addEventListener("pageshow", resetAfterReturn);
  window.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") resetAfterReturn();
  });

  // ✅ Auto redirect (registra evento y redirige)
  if (LANDING_CONFIG.UI.AUTO_REDIRECT_ENABLED) {
    const KEY = "wa_auto_redirect_fired";
    const already = sessionStorage.getItem(KEY) === "1";

    window.addEventListener("load", () => {
      setTimeout(() => {
        if (already) return;
        if (window.__waInFlight) return;
        sessionStorage.setItem(KEY, "1");
        contactarWhatsApp({ source:"auto_redirect" });
      }, LANDING_CONFIG.UI.AUTO_REDIRECT_DELAY_MS || 10000);
    });
  }
});
</script>
</body>
</html>
